# Workflow for evaluting how many modules are covered by WAF tests compared to the baseline
name: .Platform - Get WAF test coverage

on:
  schedule:
    - cron: "30 4 * * *" # Every day at 4:30 am
  workflow_dispatch:

jobs:
  manage-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      # - uses: tibdex/github-app-token@v2
      #   id: generate-token
      #   with:
      #     app_id: ${{ secrets.TEAM_LINTER_APP_ID }}
      #     private_key: ${{ secrets.TEAM_LINTER_PRIVATE_KEY }}
      - name: sync avm modules list
        shell: pwsh
        env:
          # GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }} # token with actions:read permissions on target repo
        run: |
          gh run download 13948295427 -p 'CB.AVM.WAF*'
      - name: Display structure of downloaded files
        run: |
          $dir = Get-ChildItem -Filter 'CB.AVM.WAF*'
          $dir | ForEach-Object {
            $csv = Get-ChildItem -Path $_.FullName
            $tests = Import-Csv -Path $csv.FullName
            $tests | Format-Table
          }
